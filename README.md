Qt QTextEdit点击不同文本（关键字）触发不同事件（弹出菜单）实现方案
1. 需求描述
网上找了很久也没有找到自己想要的，最后还是费了些时间（主要是笔者比较菜）自己实现了；主要需求如下：

（1）在QTextEdit中展示一些模板文本，然后一些关键数据可以进行选择替换，比如像如下代码所示，模板原始数据的一些关键数据通过方括号括起来（ [我|你|他] ），可选内容通过竖线分割，在QTextEdit中展示时只显示可选项中的一个；

QString template= "[我|你|他]有一个[梦想|想法|麻烦]。";

（2）关键数据高亮显示，点击显示所有可选项菜单，选择后进行替换；

直接看实现效果图（点击“梦想”关键字，然后选择“想法”）：

图a：点击“梦想”关键字，并弹出菜单：



图b：点击“想法”选项，将最开始显示的“梦想”替换为“想法”：



2. 整体思路
（1）主要需求点：①从模板中解析并获取关键字和相应选项 ②关键字高亮显示 ③点击关键字弹出选项菜单 ④关键字替换。

（2）第①点比较好解决，通过正则表达式，匹配所有符合格式 [anything|anything|...]，再分割各选项，正则表达式如所示下，（PS：注意由于Qt默认贪婪模式，需要设置成非贪婪模式，否则会匹配最长的的结果，比如上面匹配到的结果会变成“[我|你|他]有一个[梦想|想法|麻烦]”；而我们希望的是匹配到两个结果分别是”[我|你|他]“ 和 “[梦想|想法|麻烦]”）

QRegExp rx("(\\[\.+(\\|\.+)+\\])");
rx.setMinimal(true);
（3）关键字高亮

//class TextEdit : public QTextEdit
//TextEdit类中调用
QTextCharFormat charformat = textCursor().charFormat();
charformat.setForeground(QColor(80, 20, 250));
textCursor().setCharFormat(charformat);
textCursor().insertText(keyword);

（4）点击关键字弹出选项菜单

实现第③个需求点需要明确几个问题：

问题：

a. 怎么确定点击的是关键字？

b. 如果我再手动输入一个”想法“，那么这个想法是关键字吗？

先回答b. 以我的理解，手动输入的”想法“并不能算关键字，关键字应该是手动输入之前就确定的，手动输入的既没意义，也很奇怪，比如有些词包含这些关键字，比如”梦想成真“这种固定搭配，但其他选项却不合适；

再回到a，根据b我们很容易知道不能简单的通过判断点击的词是不是等于“想法”或“梦想”来判定当前点击的是不是关键字，也不能通过点击的位置来判断，因为文本是可以进行编辑的，关键字的位置是会变化的。

思路：

那么怎么解决这个问题呢？其实QTextEdit是支持富文本的，文本本身是“携带”一些信息的，并不是单纯的字符串，比如格式信息等；在这里我用的是QTextCharFormat的anchor，anchor本来是是用来展示超链接的；

charformat.setAnchorName(QString::number(index));
charformat.setAnchor(true);

这样我们就可以通过charformat.isAnchor()来判断点击的是不是关键字，在通过anchorName来判断点击的是哪个关键字，剩下的就是创建菜单项和触发替换文本。

if(charformat.isAnchor())
{
    ...
}

（5）关键字替换

上面几步中，我们用到的QTextCharFormat是绑定到单个字符的，也就是文本中的每个字符都有对应的QTextCharFormat信息，而我们点击的时候是判断单个字符的格式，因此我们并不知道完整的关键字有几个字符，从哪里开始到哪里结束，所以替换的时候还是有点麻烦。在这里是以点击的字符为中心向两边扫描，找出所有格式相同的字符，即为关键字的范围，替换时删掉这些字符并插入新的选项；


